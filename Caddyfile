{
	# Global options
	auto_https off
}

:{$PORT}

reverse_proxy {
	# Dynamic upstreams using SRV records
	dynamic srv {$DOWNSTREAM_HOST}-discovery.{$NAMESPACE}.svc.cluster.local

	# Sticky sessions using header-based load balancing
	lb_policy header {$STICKY_SESSION_HEADER}
	lb_try_duration 2s
	lb_try_interval 250ms

	# Health check configuration
	health_uri /health
	health_port {$DOWNSTREAM_PORT}
	health_interval 10s
	health_timeout 5s
	health_status 200

	# Transparent proxying
	header_up Host {upstream_hostport}
	header_up X-Real-IP {remote_host}

	# Add Caddy instance ID to response
	header_down X-Caddy-Render-Instance {$RENDER_INSTANCE_ID}
}
